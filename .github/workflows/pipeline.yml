name: Pipeline
on: [push, pull_request]

env:
  PYTHON_VERSION: 3.13
  POETRY_VERSION: 2.2.1
  GITHUB_ACTIONS: true

  TZ: America/Sao_Paulo
  BINANCE_APIKEY: ${{ secrets.BINANCE_APIKEY }}
  BINANCE_SECRETKEY: ${{ secrets.BINANCE_SECRETKEY }}
  POSTGRES_HOST: postgres
  POSTGRES_USER: admin
  POSTGRES_PASSWORD: minhasenha123
  POSTGRES_DB: pycrypto
  POSTGRES_PORT: 5432
  REDIS_HOST: redis
  REDIS_PORT: 6379

jobs:

  linting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies (dev only)
        run: poetry install --without doc --no-interaction

      - name: Run Ruff
        run: poetry run task ruff

      - name: Run Pylint
        run: poetry run task lint

  tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:8-alpine
        ports: [6379:6379]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies without docs
        run: |
          poetry install --without doc --no-interaction
          mkdir -p logs
          touch .env

      - name: Run tests
        env:
          POSTGRES_HOST: ${{ env.GITHUB_ACTIONS &&  'localhost' || 'postgres'}}
          REDIS_HOST: ${{ env.GITHUB_ACTIONS &&  'localhost' || 'redis'}}
        run: poetry run task test_all -m "not binance_websocket"
